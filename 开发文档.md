# 菜谱生成器 开发文档（PostgreSQL + Cloudflare R2 + Pages）

## 1. 架构概览
- 前端：React（保留现有组件），逐步引入 SSR 页面（Cloudflare Pages Functions 输出 HTML），客户端增强为交互。
- 后端：Cloudflare Pages Functions，负责调用 AI、持久化到 Postgres 与 R2、提供查询 API 与 SSR。
- 数据库：Neon Serverless Postgres（JSONB、全文检索 tsvector）。
- 对象存储：Cloudflare R2（公开只读 URL，用于图片展示）。

## 2. 代码结构（规划新增）
- `functions/api/generate.ts`：扩展生成流程，持久化与上传图片。
- `functions/recipes/index.ts`：菜谱列表 SSR（分页与搜索）。
- `functions/recipes/[slug].ts`：菜谱详情 SSR（含 JSON-LD 与 canonical）。
- `functions/daily/[date].ts`：每日推荐 SSR。
- `functions/sitemap.xml.ts`：动态站点地图（可分片）。
- `functions/robots.txt.ts`：抓取指引。
- `src/services/geminiService.ts`：新增只读查询方法：`listRecipes`、`getRecipe`、`getDailyRecommendation`。

### 页面规划（信息架构）

- 列表页
  - `/recipes/`：全部菜谱分页列表（可按最新/热门/评分等排序）。
  - `/categories/:slug`：分类页（如“家常菜”、“川菜”）。
  - `/tags/:slug`：标签页（如“鸡肉”、“低脂”）。
  - `/ingredients/:slug`：按食材聚合页（如“土豆”）。
- 详情页
  - `/recipes/:slug`：菜谱详情（唯一 URL，长尾流量核心）。
  - `/daily/:yyyy-mm-dd`：每日推荐详情页（可被索引）。
- 搜索页
  - `/search?q=...`：SSR 展示搜索结果（避免纯客户端渲染）。
- 资讯页
  - `/news/`、`/news/:slug`：文章型内容（烹饪技巧、食材科普、节日专题）。
- 导航与辅助
  - `/sitemap.xml`、`/sitemap-recipes.xml`、`/sitemap-articles.xml` 等分片站点地图。
  - `/robots.txt`、`/rss.xml`（可选：资讯站通常有 RSS）。

## 3. 数据模型与迁移（简版）
- 表结构（含 `slug` 与全文索引）：
```
CREATE EXTENSION IF NOT EXISTS pgcrypto;

CREATE TABLE recipes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  slug TEXT UNIQUE NOT NULL,
  recipe_name TEXT UNIQUE NOT NULL,
  description TEXT,
  prep_time TEXT,
  cook_time TEXT,
  ingredients JSONB NOT NULL,
  instructions JSONB NOT NULL,
  image_key TEXT,
  image_url TEXT,
  source TEXT NOT NULL CHECK (source IN ('user','daily')),
  created_at TIMESTAMPTZ DEFAULT now(),
  search_text tsvector GENERATED ALWAYS AS (
    to_tsvector('simple', coalesce(recipe_name,'') || ' ' || coalesce(description,''))
  ) STORED
);
CREATE INDEX idx_recipes_search ON recipes USING GIN (search_text);

CREATE TABLE daily_recommendations (
  recommend_date DATE PRIMARY KEY,
  recipe_id UUID NOT NULL REFERENCES recipes(id)
);

CREATE TABLE generations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  ingredients_text TEXT NOT NULL,
  selected_recipe_id UUID REFERENCES recipes(id),
  created_at TIMESTAMPTZ DEFAULT now()
);
```
- 迁移策略：
  - 新增 `slug` 列后对历史数据生成唯一 slug（拼音转写）。
  - 建立 `UNIQUE(slug)` 与 `UNIQUE(recipe_name)` 保障链接稳定。

## 4. 后端实现计划
- 生成流程改造（`functions/api/generate.ts`）：
  - `generateDetails`：
    1) 调用 GenAI 获取详情与图片（base64）。
    2) 上传图片到 R2，记录 `image_key` 与公开 `image_url`。
    3) 生成 `slug`，写入/更新 `recipes`（UPSERT）。
    4) 记录 `generations` 日志。
  - `generateRotd`：
    1) 同上生成并上传图片，持久化到 `recipes`。
    2) 写入/更新 `daily_recommendations`（当天唯一）。
- 查询端点：
  - `GET /api/recipes?page&limit&q`：`OFFSET/LIMIT` 分页；`q` 用 `search_text @@ to_tsquery` 或 `plainto_tsquery`。
  - `GET /api/recipes/:id`：按 `id` 返回详情。
  - `DELETE /api/recipes/:id`：删除菜谱；可选删除 R2 图片（配置软删除/硬删除）。
  - `GET /api/daily/:date`：按日期返回推荐菜谱。
- 错误与返回约定：统一 `{ error: string }`；400/404/500 对应参数/不存在/服务端异常。

## 5. 前端实现计划
- 服务层（`src/services/geminiService.ts`）：
  - 增加 `listRecipes`, `getRecipe`, `getDailyRecommendation` 的封装。
  - 生成成功后展示来自持久化的 `image_url`。
- 页面与组件：
  - 列表页：SSR 输出首屏 HTML，React 只负责分页交互与收藏。
  - 详情页：SSR 输出主要内容与 JSON-LD；React 负责交互（分享/收藏）。
  - 搜索页：SSR 结果，客户端增强筛选。

## 6. 环境变量与绑定
- Pages 项目变量：
  - `GEMINI_API_KEY`
  - `DB_CONNECTION_STRING`（Neon Postgres，推荐 `@neondatabase/serverless`）
  - `R2_BUCKET`（绑定名称）
  - `R2_PUBLIC_BASE_URL`（R2 公共域名前缀）
- 本地开发：`wrangler pages dev` 注入上述变量；Vite 代理 `/api`。

## 7. 部署流程
1) 在 Neon 创建数据库与用户，拿到连接串并配置到 Pages 项目。
2) 在 Cloudflare 创建 R2 桶并绑定到 Pages，配置公开访问域名。
3) 运行迁移 SQL 创建表与索引（含 `slug` 与全文检索）。
4) 部署到 Pages（构建产物与 Functions 一并上线）。

## 8. 测试与验证
- 单元：
  - slug 生成与去重；服务层请求封装与错误处理。
- 集成：
  - `generateDetails/Rotd` 端到端（AI→R2→DB）。
  - 查询端点分页与搜索；详情页 SSR JSON-LD 注入。
- 验证用例：
  - 新生成菜谱能在 `/recipes/:slug` 访问并显示图片。
  - `sitemap.xml` 包含新页面链接且可访问。

## 9. 运维与监控
- 日志：记录生成、上传、写库失败；接口响应时间与错误率。
- 缓存：HTML `s-maxage` 与短 TTL；图片长 TTL 与 ETag。
- 报警：生成失败/上传失败/写库失败触发通知（后续可加）。

## 10. 风险与缓解
- 边缘到外部 DB 网络波动：重试与超时控制；列表/详情页加缓存。
- 图片权限与链接稳定性：只读公开；命名策略 `recipes/{slug}-{timestamp}.png` 避免覆盖。
- 成本：限速与缓存；批量生成/站点地图更新设定频率。

## 11. 未来扩展
- 用户体系与鉴权：私有收藏与评论。
- 内容运营模块：`articles` 表与资讯 SSR；分类与标签体系。
- 更强检索：对 ingredients/instructions 建索引或物化视图，提升查询体验。