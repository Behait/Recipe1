# 菜谱生成器 技术文档

本项目是一个基于 React + Vite 的前后端一体化应用，使用 Google GenAI 提供智能菜谱生成、菜谱详情以及图片生成服务。前端通过 TailwindCSS 构建现代化的用户界面，后端通过 Cloudflare Pages Functions 暴露统一的 `/api/generate` 接口，向前端提供结构化 JSON 响应。

---

## 项目概览
- 应用名称：`菜谱生成器`
- 目标：根据用户输入的食材生成菜谱建议，获取某个菜谱的详细做法，并每日提供“今日推荐”菜谱；同时生成菜谱配图。
- 主要能力：
  - 基于食材生成 3 个菜谱名称建议。
  - 选中某个菜谱后生成详细菜谱（描述、时间、食材、步骤）。
  - 生成菜谱图片（base64 Data URL）。
  - “今日推荐”菜谱每日缓存于本地。
  - 菜谱保存/查看/删除，本地持久化。

---

## 技术栈
- 前端：`React 19`、`TypeScript`、`Vite 5`、`TailwindCSS`
- 后端：`Cloudflare Pages Functions`
- AI 服务：`@google/genai`（Gemini 2.5 文生内容、Imagen 4.0 生图）
- 包管理：`npm`

---

## 目录结构
```
/                      # 仓库根目录
├─ index.html          # Vite 入口 HTML，挂载根节点并引入 /src/index.tsx
├─ package.json        # 项目依赖与 scripts
├─ vite.config.ts      # Vite 配置（含 /api 代理到 wrangler dev）
├─ tailwind.config.js  # Tailwind 配置（扫描 src/** 与 index.html）
├─ postcss.config.js   # PostCSS 配置
├─ tsconfig.json       # TypeScript 配置
├─ metadata.json       # 应用元信息
├─ README.md           # 基础运行说明
├─ functions/          # Cloudflare Pages Functions 目录
│  └─ api/generate.ts  # 统一后端接口入口（POST）
├─ src/                # 前端源码（推荐作为唯一可信源）
│  ├─ index.tsx        # React 入口，挂载 App
│  ├─ index.css        # Tailwind 基础样式导入
│  ├─ App.tsx          # 应用根组件，保存/查看菜谱、今日推荐状态管理
│  ├─ types.ts         # 核心类型定义（Recipe）
│  └─ components/      # UI 组件
│     ├─ Header.tsx
│     ├─ Footer.tsx
│     ├─ HomeScreen.tsx
│     ├─ IngredientInput.tsx
│     ├─ LoadingSpinner.tsx
│     ├─ ErrorMessage.tsx
│     ├─ RecipeOptionsList.tsx
│     ├─ RecipeDisplay.tsx
│     ├─ RecipeOfTheDay.tsx
│     └─ SavedRecipes.tsx
└─ 其它：
   ├─ sw.js / register-sw.js  # Service Worker 相关文件，当前未在 index.html 中启用
   ├─ 根目录下的重复 App/组件/services/types 文件（历史遗留），请以 src/ 为准
```

说明：当前有效入口由 `index.html` 指向 `/src/index.tsx` 与 `/src/index.css`，请将开发修改集中在 `src/` 目录。根目录下存在与 `src/` 重复的文件（如 `App.tsx`、`components`、`services`、`types.ts`），建议后续清理，以减少歧义。

---

## 前端架构与数据流
- 入口：`/src/index.tsx` 挂载 `App` 到 `#root`。
- 根组件：`/src/App.tsx`
  - 管理 `savedRecipes`（本地保存）、`currentRecipe`（当前查看）、`showSaved`（弹层开关）。
  - “今日推荐”菜谱：首次加载时调用 `generateRecipeOfTheDay()`，以 `localStorage` 通过键 `recipeOfTheDay-YYYY-MM-DD` 做天粒度缓存，并在生成新推荐时清理旧键。
  - 打开“我保存的菜谱”弹层（`SavedRecipes`）查看/删除保存的菜谱。
- 主屏：`/src/components/HomeScreen.tsx`
  - 输入食材（`IngredientInput`）后调用 `generateRecipeOptions(ingredients)` 获取 3 个菜谱建议（`RecipeOptionsList`）。
  - 选择建议后调用 `generateRecipeDetails(recipeName, ingredients)` 获取详情并展示于 `RecipeDisplay`。
  - 错误展示与重试逻辑：`ErrorMessage` 接收可选 `onRetry`。
  - 加载态：`LoadingSpinner`。
  - “今日推荐”：通过 `RecipeOfTheDay` 卡片展示，点击“查看详情”会将推荐菜谱设为当前菜谱。
- 常用 UI：`Header`（保存菜谱入口）、`Footer`（版权与品牌文案）、`Welcome`（空态提示）。
- 持久化：
  - `savedRecipes` 持久化到 `localStorage`。
  - 保存时避免重复（按 `recipeName` 比对）。

---

## 核心类型
文件：`/src/types.ts`
```
export interface Recipe {
  id?: string;
  recipeName: string;
  description: string;
  prepTime: string;
  cookTime: string;
  ingredients: string[];
  instructions: string[];
  imageUrl?: string;
}
```
- 后端返回 `Recipe` 的结构与上述字段对齐；前端在 `generateRecipeDetails` 与 `generateRecipeOfTheDay` 阶段会补充 `imageUrl`。

---

## 后端接口设计（Cloudflare Pages Functions）
- 入口：`/functions/api/generate.ts`
- HTTP：`POST /api/generate`
- 请求体：`{ type: string; payload: object }`
- 验证：需要在 Cloudflare 环境变量中设置 `GEMINI_API_KEY`
- 路由分发：通过 `type` 字段选择执行逻辑
  - `generateOptions`
    - 输入：`{ ingredients: string }`
    - 模型：`gemini-2.5-flash`
    - 返回：`{ recipes: string[] }`（3 个中文菜谱名称）
  - `generateDetails`
    - 输入：`{ recipeName: string; ingredients: string }`
    - 模型：`gemini-2.5-flash`
    - 返回：`Recipe`（不含 `imageUrl`）
  - `generateRotd`
    - 输入：`{}`
    - 模型：`gemini-2.5-flash`
    - 返回：`Recipe`（不含 `imageUrl`）
  - `generateImage`
    - 输入：`{ recipeName: string }`
    - 模型：`imagen-4.0-generate-001`
    - 返回：`{ imageUrl: string }`（`data:image/png;base64,...`）

- 响应结构：
  - `generateOptions`/`generateDetails`/`generateRotd`：直接返回 `ai.models.generateContent(...).text`（为 JSON 字符串，匹配 `responseSchema`）。
  - `generateImage`：从 `generatedImages[0].image.imageBytes` 转为 `data:` URL。
- 错误处理：
  - 未配置环境变量返回 `500`；错误消息：`API key is not configured on the server.`
  - 其它异常返回 `500`；错误消息包含 `error.message`（若存在）。

---

## 前端服务封装（`/src/services/geminiService.ts`）
- 公共方法：`callApi<T>(type, payload) -> Promise<T>`
  - `fetch('/api/generate', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type, payload }) })`
  - 非 2xx 时尝试解析错误 JSON：`{ error: string }` 并抛出 `Error`。
- 业务方法：
  - `generateRecipeOptions(ingredients: string): Promise<string[]>`
  - `generateRecipeDetails(recipeName: string, ingredients: string): Promise<Recipe>`
    - 内部先取详情，再调用 `generateRecipeImage(recipeName)` 合并成完整 `Recipe`（含 `imageUrl`）。
  - `generateRecipeOfTheDay(): Promise<Recipe>`
    - 逻辑同上，生成“今日推荐”的详情与图片。
  - `generateRecipeImage(recipeName: string): Promise<string>`
    - 出错时返回空字符串以不破坏 UI 显示。

---

## 错误处理与健壮性
- 后端：统一 JSON 错误结构，覆盖未配置 `GEMINI_API_KEY`、类型无效、模型调用异常等场景。
- 前端：
  - `callApi` 捕获错误并抛出至 UI 层。
  - `HomeScreen` 中分别在生成建议、生成详情阶段设置 `ErrorMessage` 与 `onRetry` 回调。
  - 图片生成失败时，`imageUrl` 为空，前端条件渲染避免破坏布局。

---

## 状态持久化与缓存策略
- `localStorage` 键：
  - `savedRecipes`：保存的菜谱列表，去重依据为 `recipeName`。
  - `recipeOfTheDay-YYYY-MM-DD`：当天的“今日推荐”缓存；在生成新推荐前会清理旧键，避免膨胀。

---

## 样式与主题
- 样式系统：`TailwindCSS`
  - `index.css` 导入 `@tailwind base; @tailwind components; @tailwind utilities;`
  - 设计风格：浅色/深色主题适配，强调 `emerald` 绿色品牌色，卡片化布局与动画（如 `animate-fade-in-fast`）。
- 扫描范围：`tailwind.config.js` 指定 `./index.html` 与 `./src/**/*.{js,ts,jsx,tsx}`。

---

## 本地开发与运行
- 先决条件：`Node.js`（建议 v18+）
- 安装依赖：`npm install`
- 运行开发服务器：`npm run dev`
  - Vite 开发服务器将把 `/api` 代理到 `http://localhost:8788`（`wrangler pages dev` 默认地址）。
  - 请在另一个终端启动 Cloudflare Pages Functions 本地开发：
    - `wrangler pages dev`（确保已安装并登录 wrangler）
    - 在 wrangler 环境中配置 `GEMINI_API_KEY`
- 预览构建：`npm run preview`
- 生产构建：`npm run build`

---

## 部署到 Cloudflare Pages
1. 创建 Cloudflare Pages 项目并绑定此仓库。
2. 构建命令：`npm run build`，输出目录：`dist`。
3. 在 Pages 项目设置中添加环境变量：`GEMINI_API_KEY`。
4. 确保 `functions/api/generate.ts` 位于 Pages Functions 约定目录（`functions/`）。
5. 部署后前端通过 `/api/generate` 与后端通信。

---

## 环境变量配置
- `GEMINI_API_KEY`：用于调用 Google GenAI 与 Imagen。
  - 本地 wrangler：在 `wrangler.toml` 或启动命令中注入。
  - 线上 Pages：在项目设置的 Environment Variables 中添加。

---

## 安全与合规
- API Key 仅在服务端使用与存储，前端不暴露。
- 返回内容使用 `responseSchema` 限定 JSON 结构，减少非预期输出。
- 图片以 `data:` URL 返回并内联使用，不落盘。

---

## 未来扩展建议
- 账号体系与云端存储：将本地 `savedRecipes` 迁移至后端存储，支持跨设备同步。
- 更丰富的筛选条件：口味、饮食偏好（素食/低糖/无麸质）、时间、难度等。
- 国际化：当前为中文界面，可扩展多语言方案（如 `react-intl`/`i18next`）。
- 观测与限流：对后端增加速率限制与日志监控，避免滥用与控制成本。
- UI 细节：为图片生成增加占位符与重试按钮，提升体验。
- 重复文件清理：将根目录下重复的 `components/`、`services/`、`types.ts` 等迁移/删除，以 `src/` 为唯一真源。

---

## 常见问题（FAQ）
- Q：运行时报 `/api/generate` 连接失败？
  - A：确认已启动 `wrangler pages dev`（默认 `http://localhost:8788`），并已在环境中配置 `GEMINI_API_KEY`。
- Q：图片为空？
  - A：`generateImage` 失败时会返回空字符串，UI 将隐藏图片。检查 `GEMINI_API_KEY` 权限与配额。
- Q：为什么有两个 `App.tsx`？
  - A：历史遗留导致根目录与 `src/` 重复；请以 `src/` 版本为准，并建议后续清理根目录重复文件。