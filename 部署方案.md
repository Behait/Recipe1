# 部署方案（GitHub + Cloudflare Pages + Neon Postgres + R2）

仓库地址：https://github.com/Behait/Recipe1

本方案覆盖：推送到 GitHub、创建 Cloudflare Pages 项目、配置 Neon Postgres 与 R2、设置环境变量与绑定、部署与验证、常见问题与成本建议。

---

## 0. 前提与目标
- 目标：将 SSR 页面与 API（Cloudflare Pages Functions）上线，并连接 Neon Postgres 与 Cloudflare R2（对象存储）。
- 你需要的账号：GitHub、Cloudflare、Neon。
- 本地需安装：Node.js 18+、npm。

## 1. 推送到 GitHub
1) 初始化并推送（如本地还未绑定远程）：
```
git init
git add .
git commit -m "init"
git branch -M main
git remote add origin https://github.com/Behait/Recipe1.git
git push -u origin main
```
2) 确认 GitHub 仓库可见（私有/公开按需设置）。
3) 已有仓库后续推送（常用场景）：
```
git status
git add -A
git commit -m "feat: 描述改动"
git push
```
4) 远程仓库检查/修改：
```
git remote -v
git remote set-url origin https://github.com/Behait/Recipe1.git
```
5) 分支与上游跟踪：
```
git checkout -b feature/tailwind-unify
git push -u origin feature/tailwind-unify
git switch main
git pull --rebase origin main
```
6) 标签发布（可选）：
```
git tag -a v0.1.0 -m "初始发布"
git push origin v0.1.0
```
7) 常见提醒：
- 推送前建议先执行 `git pull --rebase origin main` 以减少冲突。
- 避免使用 `--force` 推送；如确需强制推送，请确认风险并与协作者同步。
- 若误跟踪临时文件：`git rm -r --cached <path>` 后再提交。
--------------------------
你可以直接执行

- 查看远程与代理
  - git remote -v
  - git config --global --get http.proxy
  - git config --global --get https.proxy
- 切换到 HTTP/1.1 并重试推送
  - git config --global http.version HTTP/1.1
  - git push -v origin main


## 2. Neon Postgres（数据库）
1) 在 Neon 控制台创建 Project 与 Database，复制连接串（推荐包含 `?sslmode=require`）：
```
postgresql://<user>:<password>@<host>/<database>?sslmode=require
```
2) 在 SQL Editor 运行初始化 SQL（一次性）：
```
CREATE EXTENSION IF NOT EXISTS pgcrypto;

CREATE TABLE recipes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  slug TEXT UNIQUE,
  recipe_name TEXT UNIQUE NOT NULL,
  description TEXT,
  prep_time TEXT,
  cook_time TEXT,
  ingredients JSONB NOT NULL,
  instructions JSONB NOT NULL,
  image_key TEXT,
  image_url TEXT,
  source TEXT NOT NULL CHECK (source IN ('user','daily')),
  created_at TIMESTAMPTZ DEFAULT now()
);

CREATE TABLE daily_recommendations (
  recommend_date DATE PRIMARY KEY,
  recipe_id UUID NOT NULL REFERENCES recipes(id)
);

CREATE TABLE generations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  ingredients_text TEXT NOT NULL,
  selected_recipe_id UUID REFERENCES recipes(id),
  created_at TIMESTAMPTZ DEFAULT now()
);
```
3) 历史数据若新增了 `slug` 列，需批量生成唯一 slug（参考 `functions/_lib/slug.ts`），并确保唯一约束。

## 3. Cloudflare R2（对象存储）
1) 在 Cloudflare 创建 R2 Bucket，命名如 `recipe-images`。
2) 启用公共访问域或自定义域，得到公开前缀（示例）：
```
https://pub-xxxxxxxxxxxxxxxxxx.r2.dev
```
https://pub-944af2152eab4765862e07d7cd07b424.r2.dev

3) 记录 Bucket 名与公开前缀，用于 Pages 绑定与环境变量。

## 4. 创建 Cloudflare Pages 项目
1) Cloudflare Pages → Create project → Connect to Git（选择 `Behait/Recipe1`）。
2) Build 设置：
- Build command: `npm run build`
- Output directory: `dist`
- Root directory: 仓库根目录（默认即可）
3) Functions：`functions/` 目录会自动识别为 Pages Functions（API/SSR）。
4) Compatibility Date：在 Pages 项目 Settings → Functions 中设置为较新的日期（例如最近日期），与本地保持一致。

## 5. Pages 环境变量与绑定
在 Pages 项目 Settings → Environment Variables（Production 与 Preview 都建议设置）：
- `DB_CONNECTION_STRING`：Neon 连接串。
- `GEMINI_API_KEY`：若使用生成接口（`/api/generate`）。
- `R2_PUBLIC_BASE_URL`：你的 R2 公开前缀（如 `https://...r2.dev`）。
- 生成图片（Vertex AI）相关：
  - `GOOGLE_GENAI_USE_VERTEXAI`：设为 `True` 以启用 Vertex AI 模式。
  - `GOOGLE_CLOUD_PROJECT`：你的 GCP 项目 ID（已启用 Vertex AI）。
  - `GOOGLE_CLOUD_LOCATION`：区域，推荐 `global` 或官方支持的区域。

在 Pages 项目 Settings → Functions → Bindings：
- R2 Buckets：新增绑定，Binding name 必须为 `R2_BUCKET`，Bucket 选择你创建的 R2 桶。

## 6. 部署与回滚
- 在 Pages 项目中触发部署（Push 到 main 或手动部署）。
- 部署完成后可在 `Deployments` 查看预览与生产环境。
- 发现问题时：
  - 快速修复→推送→自动触发新部署。
  - 需要立即回滚→在 Deployments 选择上一个稳定版本进行 Rollback。

## 7. 本地联调（可选)
- 安装依赖：`npm install`
- 本地预览 Functions/SSR：
```
npx -y wrangler pages dev . --port 8789 --compatibility-date=2025-10-27
```
- 访问：
  - 列表页：`http://127.0.0.1:8789/recipes/`
  - 分类索引：`http://127.0.0.1:8789/categories/`
  - 分类列表：`http://127.0.0.1:8789/categories/家常菜`
  - 每日推荐：`http://127.0.0.1:8789/daily/2025-10-27`
  - 站点地图：`http://127.0.0.1:8789/sitemap.xml`
  - 订阅：`http://127.0.0.1:8789/rss.xml`
- 注意：本地若要测试图片生成与上传，需要在 `wrangler.toml` 配置 R2 绑定：
```
[[r2_buckets]]
binding = "R2_BUCKET"
bucket_name = "recipe-images"
```
并通过 `wrangler pages dev` 加载。

- 如需本地测试图片生成（Imagen 4），建议在 `wrangler.toml` 的 `[vars]` 中加入：
```
[vars]
GOOGLE_GENAI_USE_VERTEXAI = "True"
GOOGLE_CLOUD_PROJECT = "<your-project-id>"
GOOGLE_CLOUD_LOCATION = "global"
```
并确保对应的 GCP 项目已开通 Vertex AI 与图片生成权限。

- 推荐添加 `wrangler.toml` 以一次性加载变量与绑定（示例）：
```
name = "recipe1"
compatibility_date = "2025-10-27"

[vars]
DB_CONNECTION_STRING = "postgresql://<user>:<password>@<host>/<db>?sslmode=require"
GEMINI_API_KEY = "<your-key>"
R2_PUBLIC_BASE_URL = "https://pub-xxxxxxxxxxxxxxxxxx.r2.dev"

[[r2_buckets]]
binding = "R2_BUCKET"
bucket_name = "recipe-images"
```
- 本地快速验证命令：
  - 生成接口（POST）：
    ```
    curl -s -X POST "http://127.0.0.1:8789/api/generate" \
      -H "Content-Type: application/json" \
      -d "{\"ingredients\":\"西兰花、虾仁\"}"
    ```
  - 菜谱列表（GET）：`curl -s "http://127.0.0.1:8789/api/recipes?q=西兰花" | head`
  - 每日推荐（GET）：`curl -s "http://127.0.0.1:8789/daily/2025-10-27" | head`
  - 详情页（GET）：`http://127.0.0.1:8789/recipes/test-slug-001`（结合下文“附：手工数据插入”）
- Windows PowerShell：若需要临时环境变量，可使用 `$Env:VAR="value"` 在当前会话生效；但推荐使用 `wrangler.toml` 的 `[vars]` 统一管理。

## 8. 线上验证清单（部署后）
- API：
  - `GET /api/recipes`（分页/搜索 `q`）
  - `GET /api/recipes/:id`
  - `GET /api/daily/:date`
- SSR 页面：
  - `/recipes/` 列表、`/recipes/[slug]` 详情（含 OG/Twitter + JSON-LD）
  - `/daily/[date]`
  - `/categories/` 索引与 `/categories/[name]` 列表
- 抓取辅助：
  - `/sitemap.xml`、`/robots.txt`、`/rss.xml`
- 图片：详情页图片地址前缀应为 `R2_PUBLIC_BASE_URL`。
- 缓存：HTML 响应默认 `Cache-Control: public, max-age=300`；图片为长缓存（immutable）。

## 9. 常见问题与排查
- `DB not configured`：确认在 Pages 的环境变量里添加了 `DB_CONNECTION_STRING`，并重新部署。
- SSL/证书错误：确保连接串包含 `?sslmode=require`。
- 生成接口失败：检查 `GEMINI_API_KEY` 是否设置；R2 绑定是否为 `R2_BUCKET`；公开前缀是否设置为 `R2_PUBLIC_BASE_URL`。
- 站点地图/robots 报错：检查终端日志与函数输出，确保返回类型与结构正确。

## 10. 成本与性能建议
- Neon：先用免费层，关注并发与存储指标，增长后再升级。
- R2：图片读流量为主；配合长缓存减少回源成本。
- Pages：开启合适的缓存（`max-age` 与 `stale-while-revalidate`），降低数据库查询压力。
- 自动暂停与冷启动：Neon 可能自动暂停以节省成本，恢复时有少量延迟；关键页面可增加短 TTL 缓存与重试逻辑。

## 11. 附：手工数据插入（用于快速验证）
在 Neon 执行：
```
INSERT INTO recipes (slug, recipe_name, description, prep_time, cook_time, ingredients, instructions, source)
VALUES (
  'test-slug-001',
  '测试菜谱',
  '这是一条用于验证的示例数据',
  '10分钟',
  '20分钟',
  '["鸡肉","土豆","洋葱"]'::jsonb,
  '["切菜","下锅","装盘"]'::jsonb,
  'user'
);
```
部署后访问：`/recipes/test-slug-001` 验证详情页渲染与 JSON-LD。

---

如需我代为创建 `wrangler.toml` 或提供 Neon 控制台一键 SQL 文件，请告诉我，我会直接补充到仓库内并协助你完成线上验证。