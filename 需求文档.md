# 菜谱生成器 需求文档（PostgreSQL + Cloudflare R2 + Pages）

## 1. 项目背景与愿景
- 背景：现有站点通过 AI 生成菜谱与配图，前端展示为单页应用。
- 愿景：演进为资讯型菜谱站（类似菜谱网），形成可抓取的多页面内容生态，提升搜索引擎收录与自然流量。

## 2. 范围与目标
- 范围：后端持久化、图片本地化存储、面向 SEO 的页面结构与内容输出。
- 业务目标：
  - 保存并可查询所有生成的菜谱及每日推荐。
  - 构建菜谱详情页、列表页、标签/分类页、搜索页等可索引页面。
  - 提供稳定的公开图片 URL，保障长期可访问。
- 技术目标：
  - 使用 Neon Postgres 持久化结构化数据（JSONB/全文检索）。
  - 使用 Cloudflare R2 存储图片对象，公开域名访问。
  - Cloudflare Pages Functions 提供 API 与 SSR 页面。

## 3. 角色与用户故事
- 访客：浏览菜谱列表与详情，查看今日推荐，搜索菜谱。
- 内容运营（未来）：编写资讯文章，维护分类与标签，发布专题。
- 系统：在生成菜谱时自动落库并上传图片；生成每日推荐并可查询。

## 4. 功能需求
- 菜谱生成与保存
  - 输入食材 → AI 返回菜名备选 → 选择其中一个 → 生成详情与图片。
  - 将菜谱详情落库，图片上传至 R2，返回公开 URL。
- 每日推荐
  - 每日生成并保存唯一推荐菜谱（可更新），可按日期查询。
- 菜谱浏览与检索
  - 菜谱列表页分页展示，可按关键字搜索（名称/描述）。
  - 菜谱详情页（唯一 slug），包含配图、食材、步骤、时间。
- 资讯内容（规划）
  - 文章列表与详情页，支持分类/标签与站点地图（后续迭代）。

## 5. 非功能需求
- 可用性：边缘节点访问稳定；API 出错时用户有清晰提示与重试机制。
- 性能：常规列表/详情 SSR 响应边缘延迟 <200ms（依赖缓存）。
- 扩展性：JSONB 表达 ingredients/instructions；全文检索支持长尾搜索。
- 安全与合规：凭证仅在服务端，图片只读公开；日志可审计。

## 6. 数据需求
- 菜谱主数据：名称、描述、准备/烹饪时间、食材数组、步骤数组、来源（user/daily）、创建时间。
- 媒体数据：R2 存储对象，数据库保存 `image_key` 与公开 `image_url`。
- 推荐数据：每天唯一推荐，记录日期与关联菜谱。
- 生成日志：记录输入文本与所选菜谱。
- SEO 字段：`slug` 唯一、`search_text` 全文索引。

## 7. 接口需求概要
- 生成类（保留现有 `/api/generate`）：
  - `generateOptions`（不落库）；`generateDetails`（落库+R2）；`generateRotd`（每日推荐）。
- 查询类（新增）：
  - `GET /api/recipes?page&limit&q` 列表与搜索。
  - `GET /api/recipes/:id` 详情；`DELETE /api/recipes/:id` 删除（可选连带图片）。
  - `GET /api/daily/:date` 查询每日推荐。
- 错误返回：统一 `{ error: string }`，使用 400/404/500。

## 8. SEO 与页面结构需求
- 页面：`/recipes/` 列表、`/recipes/:slug` 详情、`/daily/:date`、`/search`、`/categories/:slug`、`/tags/:slug`（后续）。
- JSON-LD：详情页输出 `Recipe` 结构化数据；列表页输出 `BreadcrumbList`。
- 站点地图：`/sitemap.xml` 动态生成并分片管理；`/robots.txt` 指引抓取。
- URL：每道菜唯一 `slug`；规范化 canonical，避免重复。

## 9. 约束与假设
- 运行环境：Cloudflare Pages + Functions；外接 Neon Postgres；R2 作为对象存储。
- 图片公开访问：只读公开域；写操作仅通过后端。
- 成本控制：适度缓存与限速；避免过度生成与流量浪费。

## 10. 里程碑与验收标准
- M1：完成数据库与 R2 接入；`generateDetails/Rotd` 持久化落地。
- M2：完成查询 API 与 SSR 的详情/列表页；输出 JSON-LD。
- M3：上线 sitemap/robots；搜索引擎开始抓取与收录。
- 验收：
  - 生成的菜谱能够在 `/recipes/:slug` 访问到，图片可正常显示。
  - 列表/搜索可用，分页正确；每日推荐按日期可访问。
  - 站点地图包含新增菜谱链接并被搜索引擎发现。