# 菜谱生成器：PostgreSQL（Neon）+ Cloudflare R2 方案 需求与开发文档

---

## 一、项目背景与目标
- 背景：现有项目通过 Cloudflare Pages Functions 调用 Google GenAI 与 Imagen 生成菜谱及配图，前端以 localStorage 保存。
- 目标：引入持久化与可检索的后端存储，将生成过的菜谱（含配图本地化）和“今日推荐”、用户查询日志统一存入数据库与对象存储；提升查询、复用与运营能力。
- 选型：
  - 数据库：PostgreSQL（Neon Serverless）
  - 图片存储：Cloudflare R2（对象存储），前端使用公开 URL 展示

---

## 二、总体需求
- 功能需求
  - 生成菜谱建议（3 个名称）并查看详情。
  - 每日“今日推荐”，按日期唯一保存并可查询。
  - 生成菜谱配图并持久化到 R2；前端展示公开 URL。
  - 菜谱保存、查看、删除，来源标注（用户/每日推荐）。
  - 用户查询日志记录（输入的食材文本、选择的菜谱）。
- 非功能需求
  - 可用性：边缘环境可访问，Pages Functions 无状态，DB 与 R2 高可用。
  - 性能：常用查询需 <200ms 边缘到 Neon；列表分页；全文检索可选。
  - 扩展性：数据结构以 JSONB 表达复杂字段（ingredients/instructions）。
  - 安全：API Key 与 DB/R2 凭证仅后端持有；对象存储只读公开 URL。
  - 合规：避免在前端暴露凭证；日志可审计。

---

## 三、数据存储方案
- 关系数据（Neon Postgres）：存菜谱结构化信息与日志
- 对象存储（Cloudflare R2）：存图片二进制；DB 保存 `image_key` 与 `image_url`
- 命名策略：`recipes/{slug}-{timestamp}.png`
- 删除策略：删除菜谱时可选删除对应 R2 图片（软删除或硬删除根据需要）

---

## 四、数据模型与表设计（PostgreSQL）
- recipes（菜谱主表）
  - 字段：
    - `id UUID PK DEFAULT gen_random_uuid()`
    - `recipe_name TEXT UNIQUE NOT NULL`
    - `description TEXT`
    - `prep_time TEXT`
    - `cook_time TEXT`
    - `ingredients JSONB NOT NULL`
    - `instructions JSONB NOT NULL`
    - `image_key TEXT`（R2 对象键）
    - `image_url TEXT`（公开访问 URL）
    - `source TEXT CHECK (source IN ('user','daily')) NOT NULL`
    - `created_at TIMESTAMPTZ DEFAULT now()`
    - `search_text tsvector GENERATED ALWAYS AS (to_tsvector('simple', coalesce(recipe_name,'') || ' ' || coalesce(description,''))) STORED`
  - 索引：`GIN(search_text)`，`UNIQUE(recipe_name)`
- daily_recommendations（每日推荐）
  - `recommend_date DATE PRIMARY KEY`
  - `recipe_id UUID REFERENCES recipes(id)`
- generations（用户生成日志）
  - `id UUID PK DEFAULT gen_random_uuid()`
  - `ingredients_text TEXT NOT NULL`
  - `selected_recipe_id UUID REFERENCES recipes(id)`
  - `created_at TIMESTAMPTZ DEFAULT now()`

示例 SQL：
```
CREATE EXTENSION IF NOT EXISTS pgcrypto;

CREATE TABLE recipes (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  recipe_name TEXT UNIQUE NOT NULL,
  description TEXT,
  prep_time TEXT,
  cook_time TEXT,
  ingredients JSONB NOT NULL,
  instructions JSONB NOT NULL,
  image_key TEXT,
  image_url TEXT,
  source TEXT NOT NULL CHECK (source IN ('user','daily')),
  created_at TIMESTAMPTZ DEFAULT now(),
  search_text tsvector GENERATED ALWAYS AS (
    to_tsvector('simple', coalesce(recipe_name,'') || ' ' || coalesce(description,''))
  ) STORED
);
CREATE INDEX idx_recipes_search ON recipes USING GIN (search_text);

CREATE TABLE daily_recommendations (
  recommend_date DATE PRIMARY KEY,
  recipe_id UUID NOT NULL REFERENCES recipes(id)
);

CREATE TABLE generations (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  ingredients_text TEXT NOT NULL,
  selected_recipe_id UUID REFERENCES recipes(id),
  created_at TIMESTAMPTZ DEFAULT now()
);
```

---

## 五、后端 API 设计（Cloudflare Pages Functions）
- 现有：`POST /api/generate`（type 路由）保留，并在生成成功后持久化：
  - `generateOptions`：仅生成建议（不落库）
  - `generateDetails`：生成详情 + 图片，上传 R2，写入/更新 `recipes`，记录 `generations`
  - `generateRotd`：生成“今日推荐”，上传 R2，写入/更新 `recipes`，写入/更新 `daily_recommendations`（当天唯一）
  - `generateImage`：保留内部调用，不直接暴露给前端
- 新增查询端点：
  - `GET /api/recipes?page&limit&q`：分页与可选关键字（`q`）检索名称/描述（`tsvector`）
  - `GET /api/recipes/:id`：获取单个菜谱
  - `DELETE /api/recipes/:id`：删除菜谱（可选同时删 R2 图片）
  - `GET /api/daily/:date`：获取指定日期“今日推荐”

示例响应（简化）：
```
GET /api/recipes?page=1&limit=20&q=鸡
{
  "items": [
    {
      "id": "...", "recipeName": "宫保鸡丁", "description": "...",
      "prepTime": "15分钟", "cookTime": "20分钟",
      "ingredients": ["..."], "instructions": ["..."],
      "imageUrl": "https://r2.example.com/recipes/gongbao-..png",
      "source": "user", "createdAt": "2025-10-27T12:00:00Z"
    }
  ],
  "page": 1, "limit": 20, "total": 120
}
```

错误约定：
- 统一返回 `{ error: string }`，HTTP 状态码：400（参数）、404（资源不存在）、500（服务端异常）

---

## 六、图片处理流程（R2）
- 后端把 Imagen 返回的 base64 转为 `Uint8Array` 并 `put` 到 R2：
- 设置 `Content-Type: image/png`，返回公开 URL（`env.R2_PUBLIC_BASE_URL + image_key`）
- 命名建议：菜名 slug + 时间戳，避免覆盖并便于追踪

---

## 七、前端改造
- `src/services/geminiService.ts`
  - 保留生成接口调用；在 `generateDetails`/`generateRecipeOfTheDay` 中使用持久化后的 `image_url`
  - 新增只读接口：`listRecipes`, `getRecipe`, `getDailyRecommendation`
- `src/App.tsx` 与 `HomeScreen.tsx`
  - 读取与展示来源于服务端的菜谱；本地 `savedRecipes` 逻辑逐步迁移为服务端权威数据（可保留本地收藏功能但以服务端数据为主）
  - “今日推荐”：优先从服务端查询（按日期），本地缓存可作为 UI 加速但不是权威源

---

## 八、环境变量与绑定
- Pages 项目设置：
  - `GEMINI_API_KEY`
  - `DB_CONNECTION_STRING`（Neon，推荐 `@neondatabase/serverless` WebSocket 驱动）
  - `R2_BUCKET`（绑定名称）
  - `R2_PUBLIC_BASE_URL`（R2 公共访问域名前缀）
- 本地开发（wrangler）：
  - `wrangler pages dev` 并在本地环境注入上述变量；Vite 代理 `/api` 到 `http://localhost:8788`

---

## 九、开发计划与任务分解
- 后端
  - 改造 `functions/api/generate.ts`：在 `generateDetails` 与 `generateRotd` 分支内完成 R2 上传与 DB 写入；封装 `persistRecipe()` 与 `uploadImageToR2()`
  - 新增路由：`GET /api/recipes`、`GET /api/recipes/:id`、`DELETE /api/recipes/:id`、`GET /api/daily/:date`
  - 错误与日志：统一错误响应；对关键操作记录日志（生成、上传、写库）
- 前端
  - 服务层新增只读方法；UI 调用替换为服务端数据流
  - 图片地址展示使用 `imageUrl`（R2）
- 迁移
  - 提供一次性脚本，把本地 `savedRecipes` 导入服务端（可选）
- 测试
  - 单元：服务层与格式化函数
  - 集成：API 端到端，含 R2 上传与 Neon 写库模拟

---

## 十、测试与验证
- 本地：
  - 启动 Neon（连接字符串）、配置 R2 开发桶或使用真实桶
  - `npm run dev` + `wrangler pages dev` 联调
- 验证用例：
  - 生成详情后数据与图片均持久化
  - “今日推荐”在同一天幂等更新；查询按日期命中
  - 列表分页与搜索（`q`）工作正常
  - 删除菜谱对图片处理策略符合预期

---

## 十一、部署步骤（Cloudflare Pages）
1. 在 Neon 创建数据库，获取 `DB_CONNECTION_STRING`
2. 在 Cloudflare 创建 R2 桶，配置公开访问域名（或自定义域）
3. 在 Pages 项目中添加环境变量与 R2 绑定
4. 执行数据库迁移（运行上述 SQL）
5. `npm run build` 并部署；生成函数文件在 `functions/` 下自动生效

---

## 十二、风险与缓解
- 边缘到外部 DB 网络波动：前端做好重试与失败提示；后端使用轻量连接池（Neon 无需传统池，WebSocket 驱动更适配）
- 图片公开访问权限：确保 R2 仅公开读；写入由后端进行
- 成本控制：为生成接口增加速率限制、缓存“今日推荐”；必要时增加请求队列与告警

---

## 十三、后续扩展建议
- 用户体系与鉴权：加入账号与鉴权，区分用户私有菜谱与公共菜谱
- 更丰富检索：对 ingredients/instructions 建索引或物化视图；支持多维筛选
- 观测与运维：请求日志、失败率监控、告警与工单流程